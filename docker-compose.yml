services:
  compteur:
    build: .
    image: compteur-py:v8
    restart: unless-stopped
    ports:
      - "8020:8080"
    environment:
      - DATA_PATH=/data/state.json
      - PORT=8080
      - YEAR=2025
    volumes:
      - compteur_data:/data
      - ./config.yaml:/config/config.yaml:ro
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request,sys; sys.exit(0 if urllib.request.urlopen('http://127.0.0.1:8080/healthz').read()==b'ok' else 1)"]
      interval: 10s
      timeout: 3s
      retries: 5
volumes:
  compteur_data:
